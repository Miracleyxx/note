# 媒体录制组件

| 序号 | 版本 | 更改时间   | 更改内容规范 | 作者   |
| ---- | ---- | ---------- | ------------ | ------ |
| 1    | 1.0  | 2024-07-11 | 接口规范     | 李俞成 |

## 初始化组件

`MediaRecordComponents` 媒体组件

``` C++
	int	MRC_init(const char* logPath, int logLevel);
```

初始化视频录制服务，包括日志写入目录、日志等级等。

返回值：-1错误，初始化失败；0成功。

| 名称       | 类型          | 描述                                                     |
| ---------- | ------------- | -------------------------------------------------------- |
| `logPath`  | `const char`* | 日志地址，由上层业务指定，需包含文件名。                 |
| `logLevel` | `int`         | 日志等级，等级为0-5，如果输入数值不在该范围则用默认值2。 |

* `trace`：`logLevel`为0，表明最详细的日志级别，提供追踪程序执行流程的信息。
* `debug`：`logLevel`为1，表明调试级别的日志信息，用于调试程序逻辑和查找问题。
* `info`：`logLevel`为2，表明通知级别的日志信息，提供程序运行时的一般信息，一般建议该等级，日志信息可控，不能占用大量硬盘空间。
* `warn`：`logLevel`为3，表明警告级别的日志信息，表明可能发生错误或不符合预期的情况。
* `error`：`logLevel`为4，表明错误级别的日志信息，表明发生了某些错误或异常情况。
* `critical`：`logLevel`为5，表明严重错误级别的日志信息，表明一个致命或者不可恢复的错误信息。

通过设置日志记录器的级别，可以控制那些级别的日志进行输出。

## 服务卸载

``` C++
	int MRC_unit(); 
```

卸载服务、释放资源等。

返回值：

* -1 参数解析错误；
* -2 任务不存在；
* -3 任务已存在。

## 业务状态回调

```C++
  typedef void (*data_callback) (long taskId, long taskType, long taskStatus, long data, const char* info);

  void MRC_callback(data_callback callback);
```

| 名称         | 类型  | 描述                                                         |
| ------------ | ----- | ------------------------------------------------------------ |
| `taskId`     | long  | 上层业务传入的任务id，全局唯一且为必填项。                   |
| `taskType`   | long  | 任务类型，可区分当前回调的具体任务（如录像等），如`RecordTaskStart=101`即为录像模块。 |
| `taskStatus` | long  | 任务状态，表明当前任务的状态，可以是提示状态，也可是错误状态。 |
| `data`       | long  | 部分状态可能有回调数据，可用该字段回调。                     |
| `info`       | char* | 部分回调可附带信息，如切片成功后附带文件名等。               |

根据业务ID回调任务的状态，包括开始、错误、结束等状态。

## 媒体处理任务调用

```C++
    long MRC_task_execute(long taskId, long taskType, const char* inParameters, void *outParameters = nullptr, int len = 0);
```

### 1 录像录制任务

* `taskId`：全局唯一，标明业务ID。
* `taskType`：业务类型，录制任务如下：
  * 录像任务开始，taskType = 101。
  * 录像任务停止，taskType = 102。
  * 录像任务暂停，taskType = 103。
  * 录像任务恢复，taskType = 104。
  * 录像任务查询，taskType = 105。
  * 录像任务重试，taskType = 106。

* `inParameters`：该业务类型下的传入参数（`json`格式），具体结构跟业务类型相关，详细描述见下面接口介绍。
* `outParameters`：该业务类型下，获取指定的返回参数，返回参与由业务类型决定，详细描述见下面接口介绍。
* 返回值：
  * -1 参数解析错误；
  * -2 任务不存在；
  * -3 任务已存在。


#### 1.1 录制任务开始
![](http://192.168.0.56:8080/yfglImg/image/jkgf/4280623b3dcc482fb927c1d0fe7ee0fb/2024/ea0488b707fd433280ea8ccb436f231d/20240716173758_528.jpg)

##### 1. 1.1 业务类型

``` C++
    taskType = 101
```

##### 1.1.2 输入参数

| 名称               | 类型     | 描述                                                      |
| ------------------ | :------- | --------------------------------------------------------- |
| `IntputUrl`        | `string` | 媒体输入源地址                                            |
| `FilePath`         | `string` | 文件写入地址                                              |
| `Transport`        | `num`    | 媒体输入源协议  （`0-rtsp-tcp,1-rtsp-udp,` 其余暂不支持 ) |
| `CutFormat`        | `num`    | 录制文件切片格式（0-时间长度，1-视频大小）                |
| `CutSize`          | `num`    | 录制文件切片规格（时间为`min`，大小为M）                  |
| `OutputFileFormat` | `num`    | 输出文件格式`（0-mp4; 1-mp3; 2-mp4和mp3同时生成）`        |
| `FileNamePrefix`   | `string` | 录制文件前缀，可选填，默认用`taskId`                      |

##### 1.1.3 输出参数

##### 1.1.4 调用样例

``` json
{
    IntputUrl: "rtsp://192.168.1.1:554/stream1"
    FilePath: "./Record/"
    Transport: 0 //媒体输入源协议  （`0-rtsp-tcp,1-rtsp-udp,` 其余暂不支持 )
    CutFormat：0 // 录像切片格式（0-时间切片; 1-文件大小切片）
    CutSize: 10 //录像切片大小（时间切片单位min; 文件大小切片M）
    OutputFileFormat: 0 //输出文件格式（0-mp4; 1-mp4和mp3同时生成）
    FileNamePrefix: "record" //录制文件前缀
}
  MRC_task_execute(1, 101, jsonptr, nullptr, 0); //utf-8格式
```


#### 1.2 录制任务结束

##### 1.2.1 业务类型

``` C++
    taskType = 102
```

##### 1.2.2 输入参数

无输入参数

##### 1.2.3 输出参数

无输入参数

##### 1.2.4 调用样例

``` C++
	MRC_task_execute(1, 102, nullptr, nullptr, 0);
```

#### 1.3 录制任务暂停

该任务录制暂停后，将后续收到的视频帧舍弃，直至任务继续，恢复文件写入。

##### 1.3.1 业务类型

``` C++
    taskType = 103
```

##### 1.3.2 输入参数

无输入参数

##### 1.3.3 输出参数

无输出参数

##### 1.3.4 调用样例

``` C++
   MRC_task_execute(1, 103, nullptr, nullptr, 0);
```

#### 1.4 录制任务恢复

该任务录制暂停后，可恢复任务的下载。

##### 1.4.1 业务类型

``` C++
    taskType = 104
```

##### 1.4.2 输入参数

无输入参数

##### 1.4.3 输出参数

无输出参数

##### 1.4.4 调用样例

``` C++
     MRC_task_execute(1, 104, nullptr, nullptr, 0);
```

#### 1.5 录制任务状态查询

##### 1.5.1 业务类型

``` C++
    taskType = 105
```

##### 1.5.2 输入参数

无输入参数

##### 1.5.3 输出参数

| 名称               | 类型     | 描述                                                         |
| ------------------ | :------- | ------------------------------------------------------------ |
| `intputUrl`        | `char *` | 媒体输入源地址                                               |
| `filePath`         | `char *` | 文件写入地址                                                 |
| `transport`        | `int`    | 媒体输入源协议  （`0-rtsp-tcp,1-rtsp-udp,` 其余暂不支持 )    |
| `cutFormat`        | `int`    | 录制文件切片格式（0-时间长度，1-视频大小）                   |
| `cutSize`          | `int`    | 录制文件切片规格（时间为`min`，大小为M）                     |
| `outputFileFormat` | `int`    | 输出文件格式`（0-mp4; 1-mp3; 2-mp4和mp3同时生成）`           |
| `taskStatus`       | `int`    | 当前任务状态，0-任务不存在，1-任务执行中，2-任务暂停，3-任务执行异常 |
| `taskStatusDesc`   | `int`    | 当前任务状态的描述信息，用于返回当前任务状态的的详细描述码，见[录像录制任务状态码]() |
| `currentProcess`   | `int`    | 当前任务的下载进度，和`CutSize`相比较的万分比                |
| `cutFileNum`       | `int`    | 当前任务下已切片的数量                                       |

##### 1.5.4 调用样例

```C++
#define WRITE_FILE_PATH_LEN 1024
#define INPUT_MEDIA_SOURCE_LEN 1024
struct RecordTaskParams{
    char    intputUrl[INPUT_MEDIA_SOURCE_LEN]; //录制视频输入源，如rtsp
    char    filePath[WRITE_FILE_PATH_LEN]; //录制视频输入
    int     transport; //媒体输入源协议  （`0-rtsp-tcp,1-rtsp-udp,` 其余暂不支持 ) 
    int     cutFormat; //录像存储规格（0-时间长度，1-视频大小）
    int     cutSize; //录像存储大小（时间为min，大小为M）
    int     outputFileFormat; //输出文件格式`（0-mp4; 1-mp3; 2-mp4和mp3同时生成）`
    int     taskStatus; //当前任务状态，0-任务不存在，1-任务执行中，2-任务暂停，3-任务执行异常
    int     taskStatusDesc; //当前任务状态的描述信息，用于返回当前任务状态的的详细描述码
    int     currentProcess; //当前任务的下载进度，和`CutSize`相比较的万分比
    int     cutFileNum; //当前任务下已切片的数量   
};

RecordTaskParams params;
MRC_task_execute(1, 105, nullptr, (void*)&params, sizeof(params)); //调用该接口后，可在RecordTaskParams结构体填充信息

```

##### 1.5.5 录制任务状态码

如下状态码，可通过回调函数上报状态，也会在任务查询接口的`taskStatus`字段更新`taskStatusDesc`的描述。

| 名称              | 类型 | 数值  | 描述                                                         | 状态查询方式                                                 |
| :---------------- | ---- | ----- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| `RtspTimeOut`     | int  | 10001 | rtsp协议建联失败                                             | 1. 回调函数上报                                             2. taskStatus为3时，taskStatusDesc字段为10001 |
| `RecvTimeOut`     | int  | 10002 | 如果`rtsp`连接后，媒体平台发流异常长时间收不到音视频帧，则报出网络超时 | 1. 回调函数上报                                             2. taskStatus为3时，taskStatusDesc字段为10002 |
| `TcpDisconn`      | int  | 10003 | TCP连接被断开，媒体侧触发的。                                | 1. 回调函数上报                                             2. taskStatus为3时，taskStatusDesc字段为10003 |
| `RecordStart`     | int  | 11000 | 表明录像已经开始，媒体服务连接成功，且录制文件创建成功       | 1. 回调函数上报                                              |
| `RecordInitFail`  | int  | 11001 | 录制模块初始化失败，文件创建失败，或者封装格式创建失败等     | 1. 回调函数上报                                             2. taskStatus为3时，taskStatusDesc字段为11001 |
| `RecordWriteFail` | int  | 11002 | 录制文件写入失败，录制过程中，出现io失败，如硬盘空间不足等   | 1. 回调函数上报                                             2. taskStatus为3时，taskStatusDesc字段为11002 |
| `RecordCutted`    | int  | 11003 | 录制文件切片成功，会在回调函数`info`字段回调文件名，文件名格式为`fileName_分片下载开始时间_分片下载结束时间_切片序号.MP*`，`filename`为101接口的传入参数， | 1. 回调函数上报                                              |

#### 1.6 录制任务重试

##### 1.6.1  业务类型

```
taskType = 106
```

上层业务可对当前任务进行重试，重试的入参不变。

##### 1.6.2 输入参数

无输入参数

##### 1.6.3 输出参数

无输出参数

##### 1.6.4 调用样例

```C++
   MRC_task_execute(1, 106, nullptr, nullptr, 0);
```

### 2 录像合并任务

* `taskId`：全局唯一，标明业务ID。
* `taskType`：业务类型，录制任务如下：
  * 录像任务开始，taskType = 201。
  * ~~录像任务停止，taskType = 202，暂时舍弃。~~
  * 录像任务查询，taskType = 203。
* `inParameters`：该业务类型下的传入参数（`json`格式），具体结构跟业务类型相关，详细描述见下面接口介绍。
* `outParameters`：该业务类型下，获取指定的返回参数，返回参与由业务类型决定，详细描述见下面接口介绍。
* 返回值：
  * -1 参数解析错误；
  * -2 任务不存在；
  * -3 任务已存在。

#### 2.1 录像合并任务开启
该任务只是从封装层面合并，录像的编码格式和分辨率不一致则失败，不做转码或者滤镜操作。
##### 2.1.1 业务类型

```
 taskType = 201
```

##### 2.1.2 输入参数

| 名称               | 类型     | 描述                                                         |
| ------------------ | :------- | ------------------------------------------------------------ |
| `files`            | `array`  | 媒体输入源地址，object数组，按拼接顺序填充                   |
| `originFileFormat` | `num`    | 输入的文件格式`（0-MP4，1-MP3）`                             |
| `outputFileFormat` | `num`    | 输出的文件格式`（0-MP4，1-MP3）`，目前只能从`MP4->MP4,MP3->MP3` |
| `outFileName`      | `string` | 输出的文件，路径加文件名                                     |

##### 2.1.3 输出参数

无输出参数

##### 2.1.4  调用样例

```C++
{
	outFileName:"./Record/cancat.mp4"
    originFileFormat: 0
    outputFileFormat: 0
    files：[
        {
          filePath:"/home/Record/test_1.mp4" //文件的路径，带文件名
        },
        {
          filePath:"/home/Record/test_2.mp4" //文件的路径，带文件名
        },
    ]
}
MRC_task_execute(1, 201, jsonptr, nullptr, 0); //utf-8格式
```

#### 2.2 录像合并任务查询

##### 2.2.1 业务类型

```
 taskType = 203
```

##### 2.2.2 输入参数

无输入参数

##### 2.2.3 输出参数

| 名称              | 类型  | 描述                                                         |
| ----------------- | :---- | ------------------------------------------------------------ |
| `taskStatus`      | `int` | 当前任务状态，0-任务不存在，1-任务进行中，2-任务暂停，3-任务执行异常 |
| `taskStatusDesc`  | `int` | 当前任务状态的描述信息，用于返回当前任务状态的的详细描述码，见[录像合并任务状态码]() |
| `concatTotalNum`  | `int` | 需合并的文件总数                                             |
| `concatCompleted` | `int` | 当前已合并结束的文件数                                       |

##### 2.2.4  调用样例

```
struct ConcatTaskParams {
    int     taskStatus; /当前任务状态，0-任务不存在，1-任务进行中，2-任务暂停，3-任务执行异常
    int     taskStatusDesc; //当前任务状态的描述信息，用于返回当前任务状态的的详细描述码
    int     concatTotalNum; //需合并的总数
    int     concatCompleted; //合并已完成的数据   
};
 ConcatTaskParams param;
 MRC_task_execute(1, 203, nullptr, (void*)&params, sizeof(ConcatTaskParams));
```

##### 2.2.3 合并任务状态码

| 名称                | 类型 | 数值  | 描述             |                                                              |
| ------------------- | ---- | ----- | ---------------- | ------------------------------------------------------------ |
| `CancatTaskStart`   | int  | 11101 | 合并任务开始     | 1.回调函数上报                                               |
| `CancatTaskFail`    | int  | 11102 | 录像合并任务失败 | 1. 回调函数上报    2. taskStatus为3时，taskStatusDesc字段为11102 |
| `CancatTaskSuccess` | int  | 11103 | 录像合并任务成功 | 1.回调函数上报                                               |
