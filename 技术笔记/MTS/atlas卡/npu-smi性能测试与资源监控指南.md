通过 `npu-smi` 工具全方位监控华为 Atlas 300V Pro (Ascend 310P) 的运行状态，涵盖实时负载、显存消耗及硬件健康度。

## 1. 测试工具箱准备

| **工具名称**      | **来源**       | **用途**                                 |
| ------------- | ------------ | -------------------------------------- |
| **`npu-smi`** | 驱动自带         | **最核心工具**。用于查看 NPU 状态、算力利用率、显存、温度等。    |
| **`msprof`**  | CANN Toolkit | **微观性能分析**。用于定位算子级耗时、流水线瓶颈（开发阶段使用）。    |
| **`htop`**    | Linux 系统     | 监控宿主机 CPU 和内存（Host 端瓶颈往往会阻塞 NPU 数据传输）。 |
| **`/proc`**   | Linux 文件系统   | 高级调试，直接查看底层硬件计数器接口。                    |

---

## 2. 实时性能监控 (高频动态)

此部分命令用于在压测或生产环境中实时观察 NPU 的负载波动。

### 2.1 综合性能数据流监控 (推荐)

此命令类似 Linux 的 `top`，可以持续刷新数据，适合观察一段时间内的波动。

**命令：**

```Shell
# 监控 Chip ID 为 0 的芯片，每 1 秒刷新一次，持续监控
# -c: 芯片ID, -d: 持续秒数(可选), -s: 监控项简写(p=power, t=temp, a=aicore, i=aicpu, c=ctrlcpu, m=memory, b=bandwidth)
npu-smi info watch -i 0 -c 0 -d 300 -s ptaicmb
```

**输出字段详细字典：**

| **字段列名**         | **全称 (Full Name)** | **含义与分析**                  | **阈值建议**                                   |
| ---------------- | ------------------ | -------------------------- | ------------------------------------------ |
| **Pwr(W)**       | Power Consumption  | **实时功耗**。反映板卡当前负载的物理压力。    | Atlas 300V Pro 典型功耗约 70W。若长期偏低说明业务未跑满。     |
| **Temp(C)**      | Temperature        | **芯片温度**。                  | 建议 < 85°C。超过 95°C 可能触发降频保护，超过 100°C 可能会停机。 |
| **AI Core(%)**   | AI Core Usage      | **AI 算力利用率**。矩阵运算单元的繁忙程度。  | 推理任务高是正常的；纯解码任务低是正常的。                      |
| **AI Cpu(%)**    | AI CPU Usage       | **逻辑控制单元**。用于算子调度和部分非矩阵运算。 | 通常较低。若持续 100% 可能是算子调度瓶颈。                   |
| **Ctrl Cpu(%)**  | Control CPU        | **控制 CPU**。负责设备管理和通信。      | 只要不长期 100% 即可。                             |
| **Memory(%)**    | Memory Usage       | **显存占用率**。                 | **关键指标**。若持续增长不降，需排查内存泄漏。                  |
| **Memory BW(%)** | Memory Bandwidth   | **显存读写带宽利用率**。             | 若此值很高但 AI Core 很低，说明瓶颈在数据搬运（IO Bound）。     |

---

## 3. 资源占用率统计 (引擎维度)

此部分主要用于查看各个专用硬件引擎（如解码器、编码器、AI核）的瞬时占用率。

**命令：**

```Shell
watch -n 1 npu-smi info -t usages -i 0
```

**关键引擎指标解析：**

|**引擎名称**|**对应字段**|**含义**|**性能调优分析**|
|---|---|---|---|
|**HBM**|Memory Capacity|**高带宽内存**|即板载显存。Atlas 300V Pro 通常为 24GB 或 48GB。**起步即满**通常是因为初始化时申请了过大的内存池。|
|**AI Core**|Aicore Usage|**矩阵计算**|深度学习推理的核心。如果利用率低，检查是否是 BatchSize 太小或数据预处理太慢。|
|**VDEC**|DVPP VDEC Usage|**视频解码**|**300V Pro 核心指标**。负责 H.264/H.265 解码。若 **>80%**，说明解码路数接近上限，容易引起丢帧。|
|**VENC**|DVPP VENC Usage|**视频编码**|**300V Pro 核心指标**。负责视频重新编码。若为 0，说明业务未使用硬件编码。|
|**VPC**|DVPP VPC Usage|**图像处理**|负责缩放(Resize)、裁剪(Crop)、格式转换(YUV->RGB)。若此项过高，考虑合并 VPC 操作。|
|**JPEGE**|DVPP JPEGE Usage|**图片编码**|负责将数据编码为 JPEG 图片（通常用于抓图业务）。|

---

## 4. 硬件与版本信息 (静态查询)

### 4.1 查看单板详细信息

用于确认固件版本、序列号及 PCIe 槽位信息。

**命令：**

```Shell
npu-smi info -t board -i 0
```

**关键字段说明：**

- **Software Version**: 驱动版本 (例如 `25.3.rc1`)。需与 CANN 软件包版本兼容。
    
- **Firmware Version**: 固件版本 (例如 `7.8.0.2.212`)。**必须与驱动版本匹配**，否则可能导致 NPU 初始化失败。
    
- **PCIe Bus Info**: 总线号 (例如 `0000:84:00.0`)。用于在宿主机 `lspci` 中定位设备，或在 Docker 挂载时区分设备。
    

### 4.2 查看产品型号

**命令：**

```Shell
npu-smi info -t product -i 0
```

- **Product Type**: 确认是 `Atlas 300V Pro` 还是 `Atlas 300I Pro`。不同卡支持的编解码能力不同。
### 5.2 进程关联查询

**场景**：显存被占满，不知道是哪个进程在用；或者需要确认某个容器是否真的用上了 NPU。

**命令：**

```Shell
npu-smi info
```

_(直接输入不带参数)_

- 在输出的最下方 `Process Information` 区域，可以看到 `Process ID` (PID) 和 `Memory-Usage`。
    

### 5.3 设备热复位 (Reset)

**场景**：程序由于 Bug 导致 NPU 挂死（Hanging），无法杀掉进程或显存无法释放，但不想重启整台物理服务器。

**命令：**

```Shell
# 警告：这会强制重置指定芯片，会导致运行在其上的业务中断
npu-smi set -t reset -i 0
```

### 5.4 查询 NPU 拓扑结构

**场景**：在多卡机器上，查看 NPU 与 CPU 的 NUMA 亲和性，用于性能绑核优化。

**命令：**

```Shell
npu-smi info -t topo
```