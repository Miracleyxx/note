这是一份专为音视频开发者设计的 **Wireshark RTP 抓包分析实战速查表**。

当你在 Wireshark 中选中一个 UDP/RTP 包，展开 `Data` 部分（或 `RTP Payload`），看到一堆十六进制（Hex）时，请对照下表快速定位问题。

---

# 🛠️ 通用 RTP 基础速查

**关注点：RTP Header (前 12 字节)**

|**现象 (Hex)**|**含义**|**专家解读**|
|---|---|---|
|**Marker Bit (M位)**|`80` (在 PT 字段前)|**关键**。如果是 1，表示这一帧结束。如果一帧没发完 M 就置 1，画面会花；如果发完了 M 还是 0，画面会卡顿/延迟。|
|**Seq Num (序列号)**|发生跳变 (如 `01 05` -> `01 07`)|**丢包**。中间少了 `01 06`。视频会马赛克，音频会爆音。|
|**Timestamp (时间戳)**|连续多个包相同|**分片**。说明这些包属于同一帧视频（FU-A/FU）。|
|**Timestamp (时间戳)**|视频跳变 `3000`~`3600`|正常。90kHz 时钟下，3600 增量约等于 25fps (90000/25)。|
|**Timestamp (时间戳)**|音频跳变 `1024`|正常。AAC-LC 标准帧长 1024 采样点。|

---

# 1. H.264 (AVC) 速查

关注点：Payload 第 1 个字节 (NAL Header)

公式：Type = Byte & 0x1F

### 核心 Hex 特征

|**Hex (示例)**|**二进制特征**|**类型**|**含义**|
|---|---|---|---|
|**67** / **27**|`...00111`|**SPS**|序列参数集。如果没有这个，无法解码。通常伴随 PPS。|
|**68** / **28**|`...01000`|**PPS**|图像参数集。|
|**65** / **25**|`...00101`|**IDR**|**关键帧** (I帧)。画面刷新的起点。|
|**61** / **41**|`...00001`|**Slice**|**P帧/B帧**。最常见的视频包。|
|**7C** / **5C**|`...11100`|**FU-A**|**分片单元**。Type=28。说明这是大帧的一部分。|

### FU-A 分片深度分析 (当 Byte 0 是 7C/5C 时)

查看 Payload 第 2 个字节 (FU Header)

公式：S = Byte & 0x80, E = Byte & 0x40

|**Hex (Byte 2)**|**S**|**E**|**含义**|**常见组合**|
|---|---|---|---|---|
|**85** / **81**|1|0|**分片开始** (Start)|`7C 85` (IDR帧开始), `5C 81` (P帧开始)|
|**05** / **01**|0|0|**分片中间** (Middle)|`7C 05` ...|
|**45** / **41**|0|1|**分片结束** (End)|`7C 45` (RTP Marker 位通常应为 1)|

> **🚩 常见错误**:
> 
> - Payload 开头看到了 `00 00 00 01`？ -> **错误**。没有去掉起始码。
>     
> - IDR 帧 (65) 出现在中间包？ -> **错误**。IDR 必须是帧的开始，如果是分片应在 FU Header 里体现。
>     

---

# 2. H.265 (HEVC) 速查

关注点：Payload 前 2 个字节 (Header)

公式：Type = (Byte1 & 0x7E) >> 1

### 核心 Hex 特征

|**Hex (Byte 0-1)**|**Type (十进制)**|**类型**|**含义**|
|---|---|---|---|
|**40 01**|32|**VPS**|视频参数集 (H.265 独有)。|
|**42 01**|33|**SPS**|序列参数集。|
|**44 01**|34|**PPS**|图像参数集。|
|**26 01**|19|**IDR**|关键帧 (IDR_W_RADL)。|
|**02 01**|1|**Trail**|普通 P 帧。|
|**62 01** / **63 ..**|49|**FU**|**分片单元**。RTP 传输中最常见的开头。|

### FU 分片深度分析 (当 Type = 49 时)

查看 Payload 第 3 个字节 (FU Header)

公式：S = Byte & 0x80, E = Byte & 0x40

|**Hex (Byte 3)**|**S**|**E**|**原始类型**|**含义**|
|---|---|---|---|---|
|**93** (10010011)|1|0|19 (IDR)|**IDR 分片开始**|
|**81** (10000001)|1|0|1 (P帧)|**P帧 分片开始**|
|**53** (01010011)|0|1|19 (IDR)|**IDR 分片结束**|

> **🚩 常见错误**:
> 
> - H.265 头是 2 字节，如果代码按 1 字节解析，所有类型都会错乱。
>     
> - 一定要找 **VPS** (Type 32)，很多 H.265 手机推流没有 VPS 只有 SPS/PPS，会导致无法播放。
>     

---

# 3. AAC (MPEG4-Generic) 速查

关注点：Payload 前 4 个字节 (AU Header Section)

前提：SDP 中 sizelength=13; indexlength=3; indexdeltalength=3

### 核心 Hex 特征

|**Hex 模式**|**解析**|**含义**|
|---|---|---|
|**00 10** `xx xx`|Length=16 bits|**单帧包**。最常见。表示后面紧跟 2 字节的 AU-Header。|
|**00 20** `xx xx`|Length=32 bits|**双帧包**。一个 RTP 包里塞了 2 个音频帧。|
|**FF F1** ...|ADTS Header|**严重错误**。RTP Payload 里出现了 ADTS 头，说明没有剥离头部直接发送了。|

### 长度计算 (Byte 2-3)

假设 Byte 2-3 是 `0C C8` (即 `0000 1100 1100 1000`)

- **计算**: `0x0CC8 >> 3` = `0x199` = **409** 字节。
    
- **校验**: 看看这一包 RTP 的总长度减去头部，是否约等于 409。
    

---

# 4. VP9 速查

**关注点：Payload 第 1 个字节 (Payload Descriptor)**

### 核心 Hex 特征

|**Hex (Byte 0)**|**二进制 (IPLFBEVZ)**|**含义**|
|---|---|---|
|**98**|`1001 1000`|**Start Frame** (I=1, B=1)。一帧的开始。|
|**90**|`1001 0000`|**Middle Frame** (I=1)。一帧的中间分片。|
|**94**|`1001 0100`|**End Frame** (I=1, E=1)。一帧的结束 (RTP Marker 应为 1)。|

### 关键检查：Picture ID

如果 Byte 0 的最高位 (I) 是 1，那么 Byte 1 (或 Byte 1-2) 就是 **Picture ID**。

- **连续性检查**: 即使 RTP Sequence Number 增加，Picture ID 在同一帧的所有分片中必须**保持不变**。在下一帧开始时，Picture ID 应该 +1。
    

---

### 💡 终极排错口诀

1. **先看 SDP**: 确定 payload type (PT) 96 到底对应 H.264 还是 H.265？
    
2. **再看 M 位**: M 位不亮，图像不出（不刷新）；M 位乱亮，图像分层。
    
3. **算算时间**: 视频时间戳增量不均匀（忽大忽小），说明帧率控制（Pacing）有问题。
    
4. **找关键帧**: 视频卡在第一帧出不来？大概率是 IDR 帧丢了，或者 SPS/PPS 没发。
    