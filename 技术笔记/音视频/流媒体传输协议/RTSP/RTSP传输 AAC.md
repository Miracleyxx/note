
---

# ğŸ“˜ æŠ€æœ¯æ‰‹å†Œï¼šRTSP/RTP ä¼ è¾“ AAC (RFC 3640 / AAC-hbr)

> ğŸ’¡ **æ ¸å¿ƒå®šä¹‰**ï¼šRFC 3640 å®šä¹‰äº†ä¸€ç§é€šè¿‡ RTP ä¼ è¾“ MPEG-4 å…ƒç´ æµçš„é€šç”¨æ ¼å¼ã€‚åœ¨ `AAC-hbr` (High Bit-rate) æ¨¡å¼ä¸‹ï¼Œé‡‡ç”¨ **Header/Data åˆ†ç¦»** æ¶æ„ï¼Œæ”¯æŒåœ¨ä¸€ä¸ª RTP åŒ…ä¸­é€šè¿‡ **ä½çº§ç´¢å¼• (Bit-level Indexing)** å°è£…å¤šå¸§æ•°æ®ã€‚

## 1. ğŸ— åè®®æ¶æ„ (Protocol Architecture)

### 1.1 æ€»ä½“å°è£…ç»“æ„

ä¸ ADTS çš„â€œæ´‹è‘±çš®â€ç»“æ„ï¼ˆæ¯å±‚åŒ…ä¸€å±‚ï¼‰ä¸åŒï¼ŒRFC 3640 é‡‡ç”¨**ç´¢å¼•è¡¨ç»“æ„**ã€‚

```Code snippet
classDiagram
class RTP_Packet {
    +RTP Header (12 bytes)
    +RTP Payload (Variable)
}
class RTP_Payload {
    +AU Header Section (Variable Bits)
    +AU Data Section (Raw Frames)
}
RTP_Packet *-- RTP_Payload
```

### 1.2 å…³é”®ä¿¡ä»¤æ˜ å°„ (SDP to Parsing)

å®¢æˆ·ç«¯å¿…é¡»å…ˆè§£æ SDP ä¸­çš„ `fmtp` å­—æ®µï¼Œè·å–è§£æ Payload å¿…é¡»çš„**ä½å®½å‚æ•°**ï¼š

|**SDP å‚æ•°**|**å˜é‡å (ä»£ç ä¸­)**|**å…¸å‹å€¼**|**ä½œç”¨**|
|---|---|---|---|
|`config`|`asc`|Hex String|**AudioSpecificConfig**ã€‚è§£ç å™¨åˆå§‹åŒ–çš„å…³é”®ï¼Œå«é‡‡æ ·ç‡ã€é€šé“ç­‰ã€‚|
|`sizelength`|`len_bits`|**13**|å†³å®š `AU-size` å­—æ®µå å¤šå°‘ä¸ª **Bit**ã€‚|
|`indexlength`|`idx_bits`|**3**|å†³å®šé¦–å¸§ `AU-Index` å­—æ®µå å¤šå°‘ä¸ª **Bit**ã€‚|
|`indexdeltalength`|`idx_delta_bits`|**3**|å†³å®šåç»­å¸§ `AU-Index-delta` å­—æ®µå å¤šå°‘ä¸ª **Bit**ã€‚|

---

## 2. ğŸ§¬ Payload ä½çº§ç»“æ„ (Bit-Level Layout)

è¿™æ˜¯è§£æå™¨æœ€å®¹æ˜“å‡ºé”™çš„åœ°æ–¹ã€‚**æ³¨æ„ï¼šè¿™éƒ¨åˆ†é€šå¸¸ä¸æ˜¯å­—èŠ‚å¯¹é½çš„ï¼**

### 2.1 AU Header Section (å¤´éƒ¨ç´¢å¼•åŒº)

ç»“æ„å¦‚ä¸‹ï¼ˆå‡è®¾åŒ…å« N ä¸ªå¸§ï¼‰ï¼š

```Plaintext
[AU-headers-length] | [AU-header 1] | [AU-header 2] | ... | [AU-header N]
<---- 16 bits ---->   <-- Var bits ->   <-- Var bits ->       <-- Var bits ->
(Network Order)
```

### 2.2 å•ä¸ª AU-header è¯¦è§£

æ¯ä¸ª AU-header çš„é•¿åº¦ = `sizelength` + `indexlength` (æˆ– `indexdeltalength`)ã€‚

- **Header 1 (é¦–å¸§)**:
    
    - `Size (13 bits)` | `Index (3 bits)`
        
- **Header 2..N (åç»­å¸§)**:
    
    - `Size (13 bits)` | `IndexDelta (3 bits)`
        

> âš ï¸ **é«˜å±å‘ç‚¹**ï¼š
> 
> 1. **å­—èŠ‚åº**ï¼š`AU-headers-length` æ˜¯ **Big Endian**ï¼Œè¯»å–å‰å¿…é¡» `ntohs`ã€‚
>     
> 2. **è·¨å­—èŠ‚ä½æ“ä½œ**ï¼š`AU-size` (å¦‚13ä½) å¿…ç„¶è·¨è¶Šå­—èŠ‚è¾¹ç•Œï¼Œä¸èƒ½ç›´æ¥ `memcpy`ï¼Œå¿…é¡»ä½¿ç”¨**ä½è¯»å–å™¨ (BitReader)**ã€‚
>     
> 3. **å¡«å……å¯¹é½**ï¼šæ ‡å‡†å»ºè®® Header Section ç»“æŸåå¯¹é½åˆ°å­—èŠ‚è¾¹ç•Œï¼ˆPaddingï¼‰ï¼ŒData Section ä»ä¸‹ä¸€ä¸ªæ•´å­—èŠ‚å¼€å§‹ã€‚
>     

---

## 3. ğŸ’» æ ¸å¿ƒå®ç°é€»è¾‘ (C++ Implementation Guide)

åŸºäºä½ æä¾›çš„ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥æç‚¼å‡ºé€šç”¨çš„**è§£æèŒƒå¼**å’Œ**æ‰“åŒ…èŒƒå¼**ã€‚

### 3.1 æ ¸å¿ƒå·¥å…·ï¼šä½è¯»å–å™¨ (BitReader)

è§£æ RFC 3640 çš„åŸºçŸ³ã€‚

```C++
// ğŸ’¡ æ ¸å¿ƒé€»è¾‘ï¼šå¤„ç†è·¨å­—èŠ‚è¯»å– (MSB first)
// buffer: æ•°æ®æº, offset: å½“å‰Bitåç§», n: éœ€è¦è¯»å–çš„ä½æ•°
uint32_t ReadBits(const uint8_t* buffer, size_t& offset, uint8_t n) {
    uint32_t value = 0;
    for (uint8_t i = 0; i < n; ++i) {
        size_t byte_pos = (offset + i) / 8;
        size_t bit_pos  = 7 - ((offset + i) % 8); // 7,6...1,0
        if ((buffer[byte_pos] >> bit_pos) & 1) {
            value |= (1 << (n - 1 - i));
        }
    }
    offset += n; // æ¨è¿›å…¨å±€åç§»é‡
    return value;
}
```

### 3.2 è§£åŒ…ç®—æ³•æµç¨‹ (Unpacking Workflow)

1. **è¯»å–æ€»é•¿åº¦**ï¼šè¯»å–å‰ 16 bits (`AU-headers-length`)ã€‚
    
2. **å¾ªç¯è§£æ Header**ï¼š
    
    - è®¡ç®— Header åŒºçš„ç»“æŸä½ä½ç½®ï¼š`end_bit_pos = current_offset + headers_length`ã€‚
        
    - `while (current_offset < end_bit_pos)` å¾ªç¯è¯»å–ï¼š
        
        - è¯» `sizelength` ä½ -> å¾—åˆ° **å¸§å¤§å°**ã€‚
            
        - è¯» `indexlength` ä½ -> å¾—åˆ° **ç´¢å¼•**ã€‚
            
        - å°†è§£æå‡ºçš„ `{size, index}` å­˜å…¥é˜Ÿåˆ—ã€‚
            
3. **å®šä½æ•°æ®æ®µ**ï¼š
    
    - `data_offset = ceil(end_bit_pos / 8.0)` (é€šå¸¸ç›´æ¥é™¤ä»¥8ï¼Œéšå«å¯¹é½)ã€‚
        
4. **åˆ‡åˆ† Payload**ï¼š
    
    - æ ¹æ®é˜Ÿåˆ—ä¸­çš„ `size`ï¼Œä» `data_offset` å¼€å§‹ä¾æ¬¡ `memcpy` å‡ºè£¸ AAC å¸§ã€‚
        

### 3.3 æ‰“åŒ…ç®—æ³•æµç¨‹ (Packing Workflow)

> **åœºæ™¯**ï¼šå°† `std::vector<Frame>` æ‰“åŒ…è¿› RTPã€‚

1. **è®¡ç®—å®¹é‡**ï¼š
    
    - `header_bits` = 16 + (N * (sizelength + indexlength))
        
    - `payload_size` = (header_bits / 8) + Sum(FrameSizes)
        
2. **å†™å…¥ Header**ï¼š
    
    - å…ˆå†™ 16ä½ `header_length`ã€‚
        
    - éå†å¸§ï¼ŒæŒ‰ä½å†™å…¥ `size` å’Œ `index`ã€‚
        
    - **æ³¨æ„**ï¼šå¦‚æœæ˜¯ `13+3=16` bitsï¼Œæ°å¥½å‡‘æ•´ä¸¤ä¸ªå­—èŠ‚ï¼Œå¯ç”¨ `htons(size<<3 | index)` ä¼˜åŒ–ï¼›å¦åˆ™å¿…é¡»æŒ‰ä½å†™ã€‚
        
3. **å†™å…¥ Body**ï¼š
    
    - ç›´æ¥è¿½åŠ æ‰€æœ‰è£¸å¸§æ•°æ®ã€‚
        

---

## 4. âš–ï¸ æ·±åº¦å¯¹æ¯”ï¼šRFC 3640 vs ADTS

è¿™ä¸ä»…ä»…æ˜¯æ ¼å¼çš„åŒºåˆ«ï¼Œæ›´æ˜¯**ä¼ è¾“ç­–ç•¥**çš„åŒºåˆ«ã€‚

|**ç‰¹æ€§**|**RFC 3640 (RTSP/RTP)**|**ADTS (TS/RTMP/File)**|**æŠ€æœ¯è¯„ä»·**|
|---|---|---|---|
|**å…ƒæ•°æ®é¢‘ç‡**|**æä½** (ä»…æ¡æ‰‹æ—¶ä¸€æ¬¡)|**æé«˜** (æ¯ä¸€å¸§éƒ½æœ‰)|RFC 3640 çœå¸¦å®½ï¼Œä½†åœ¨ä¸­é€”åŠ å…¥ç›´æ’­æ—¶ä¾èµ– IDR/SDP é‡å‘ã€‚|
|**åˆ†åŒ…é€»è¾‘**|**ä½çº§ç´§å‡‘ (Bit-packed)**|**å­—èŠ‚æµ (Byte Stream)**|RFC 3640 è§£æå¤æ‚åº¦é«˜ï¼ŒADTS è§£æç®€å•ä½†æœ‰ 7å­—èŠ‚ overheadã€‚|
|**å¤šå¸§èšåˆ**|**åŸç”Ÿæ”¯æŒ** (Header Section)|æ”¯æŒ (ä½†éœ€è¿ç»­æ‹¼æ¥)|RFC 3640 çš„èšåˆæœºåˆ¶åœ¨å¤„ç†å°éŸ³é¢‘å¸§ï¼ˆå¦‚ Opus/AACï¼‰æ—¶ç½‘ç»œæ•ˆç‡æ›´é«˜ã€‚|
|**ä¾èµ–æ€§**|**å¼ºä¾èµ– SDP**|**è‡ªåŒ…å« (Self-contained)**|ä¸¢å¤± SDPï¼ŒRFC 3640 çš„ RTP åŒ…å°±æ˜¯ä¸€å †åºŸæ•°æ®ï¼›ADTS éšä¾¿æˆªä¸€æ®µå°±èƒ½æ’­ã€‚|

---

## 5. ğŸ›  æ•…éšœæ’æŸ¥æ¸…å• (Troubleshooting Checklist)

å¦‚æœä½ åœ¨å¼€å‘ä¸­é‡åˆ°éŸ³é¢‘**çˆ†éŸ³ã€å˜è°ƒæˆ–æ— æ³•è§£ç **ï¼Œè¯·æŒ‰æ­¤é¡ºåºæ’æŸ¥ï¼š

- [ ] **SDP è§£æé”™è¯¯**ï¼š`sizelength` æ˜¯å¦çœŸçš„è¯»å¯¹äº†ï¼Ÿå¾ˆå¤šè®¾å¤‡é»˜è®¤ä¸æ˜¯ 13ï¼Œå¯èƒ½æ˜¯ 6 æˆ– 16ã€‚
    
- [ ] **Bit åç§»é”™ä½**ï¼šåœ¨è§£æå®Œ Header åï¼Œæ•°æ®æŒ‡é’ˆæ˜¯å¦**æ­£ç¡®å¯¹é½**åˆ°äº†ä¸‹ä¸€ä¸ªå­—èŠ‚ï¼Ÿ(æœ‰äº›éæ ‡å®ç°å¯èƒ½æ²¡æœ‰ padding)ã€‚
    
- [ ] **å¤§å°ç«¯é—®é¢˜**ï¼š`AU-headers-length` æ²¡è½¬å­—èŠ‚åºï¼Œå¯¼è‡´è§£æå‡ºå¤©æ–‡æ•°å­—çš„é•¿åº¦ã€‚
    
- [ ] **ASC æ•°æ®**ï¼š`config=` é‡Œçš„ Hex å­—ç¬¦ä¸²æ˜¯å¦æ­£ç¡®è½¬æ¢å¹¶å–‚ç»™äº† AAC è§£ç å™¨ï¼Ÿæ²¡æœ‰ ASCï¼Œè§£ç å™¨æ— æ³•å¯åŠ¨ã€‚
    

---